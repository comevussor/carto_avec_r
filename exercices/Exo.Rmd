---
title: "Excercices"
author: "TG & HP"
date: "16/12/2019"
output: 
  html_document: 
    highlight: pygments
    number_sections: yes
    theme: sandstone
    toc: yes
---

```{r setup, include=FALSE}

knitr::knit_hooks$set(nm = function(before, options, envir){
  if (before){
    par(mar=c(0,0,0,0))
  } 
})
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, nm=TRUE)
```

# Gestion de couches géographiques  

## Créer un projet RStudio

Créez un projet avant de démarrer l'exercice.
Il s'agit d'une bonne pratique qui vous facilitera la tâche.
Cela améliore l'organisation et la portabilité de votre travail.


## Télécharger la couche des géométries des communes d'Occitanie

Une couche géographique des communes d'Occitanie au format **gpkg** est 
disponible ici :  
///insert link///  
Téléchargez et décompressez la dans un dossier data placé dans votre projet.  

Source : ADMIN EXPRESS COG édition 2019 (IGN, 
http://professionnels.ign.fr/adminexpress)


## Charger la couche géographique dans R

* Créez un fichier **exo1.R** à la racine de votre projet. 
* Chargez la couche géographique des communes d'Occitanie en utilisant 
le package `sf` et la fonction `st_read()`. 
* Vérifiez le système de projection avec `st_crs()`. S'agit-il de données 
projetée ? Si ce n'est pas le cas, transformez la couche des communes dans la 
projection française (Lambert 93) avec la fonction `st_transform()`. 

```{r}
library(sf)
occ_raw <- st_read(dsn = "data/Occitanie.gpkg", stringsAsFactors = FALSE)
st_crs(occ_raw)
occ <- st_transform(x = occ_raw, crs = 2154)
```


## Création d'une nouvelle couche - Sélection par attributs

* Séléctionnez toutes les communes de la Haute-Garonne. 
* Enregistrez votre séléction dans un nouvel objet nommé **com31**
* Afficher la nouvelle couche (en utilisant notament `st_geometry()`)

Pour connaitre la liste de tous les noms ou code de région on peut utiliser la 
fonction `unique()`. 

```{r}
unique(occ$INSEE_DEP)
com31 <- occ[occ$INSEE_DEP == "31", ]
plot(st_geometry(com31))
```

## 4) CREATION D'UNE NOUVELLE COUCHE - PAR FUSION D'ENTITES GEOGRAPHIQUES

* Fusionnez les communes de la région en un seul polygone, utilisez la fonction 
`st_union ()`. 
* Créez la couche géograpique des départements de la région, utilisez la 
fonction `aggregate()` pour regrouper les polygones et calculer la somme des
populations communales. 
* Affichez les résultats (communes, départements et région)

```{r}
reg76 <- st_union(occ)
dep76 <- aggregate(occ["POPULATION"], by = list(occ$INSEE_DEP), sum)
plot(st_geometry(occ), col = "lightblue1", border = "white", lwd = .5)
plot(st_geometry(dep76), col = NA, border = "lightblue2", lwd = 1, add = TRUE)
plot(reg76, col = NA, border = "lightblue3", lwd = 2, add = TRUE)
```

## Création d'une nouvelle couche - Zone tampon

* Créez une zone tampon d'une distance de 10 km autour des limites de la commune 
de Toulouse (INSEE_COM = 31555) avec `st_buffer()`.

```{r}
com31555 <- com31[com31$INSEE_COM == "31555",]
com31555_buffer <- st_buffer(com31555, 10000)

```


## Création d'une nouvelle couche - Sélection par localisation

Déterminez quelles communes de la Haute-Garonne intersectent le buffer créé.

* Utilisez la fonction `st_intersects()`. 
* Inserez directement le resultat comme variable de l'objet **dep31**.




## AFFICHAGE DE COUCHE GEOGRAPHIQUE

Affichez/superposez toutes les couches géographiques créees :
Couche des communes de votre région
Couche des communes intersectées par le buffer
Couche de votre commune séléctionnée
Couche du buffer 
Couche des départements de votre région
Couche des limites de votre région

Jouez sur les styles pour les différencier... 



## CREATION D'UNE COUCHE DE POINT - A PARTIR DE LONG ET LAT

Créer un objet sf (points) contenant la localisation de la préfécture de région
Vous pouvez récupérer la longitude et la latitude sur Google Map ou OSM
Créer un point avec st_points(), puis l'objet sf avec st_sfc() et st_sf()


## CALCUL D'UNE MATRICE DE DISTANCE - distance entre des points

Calculez une matrice de distance entre la préfecteure et les centroïdes des
communes de votre région. Pour cela, utiliser la fonct st_distance()
N'oubliez pas de vérifier les projections utilisées avec st_transform()


## CARTOGRAPHIE D'UNE VARIABLE D'UN OBJET SF

Essayer de cartographier (uniquement) la distance de chaque commune à la 
préfecture de la  région avec la fonction plot...
